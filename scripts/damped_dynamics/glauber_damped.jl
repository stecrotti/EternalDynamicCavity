using JLD2
using MatrixProductBP, MatrixProductBP.Models
using LinearAlgebra
using Logging
Logging.disable_logging(Logging.Warn)

k = 3

J = 0.4
β = 1.0
h = 0.2
k = 3
w = HomogeneousGlauberFactor(J, h, β)

(m_ss, r_ss) = equilibrium_observables(RandomRegular(k), J; β, h, tol=1e-12)

p0s = 10.0 .^ (-0.5:-0.5:-2)
p0s = 1 .- 10.0 .^ (0:-1:-4)
p0s = 0.05:0.1:0.95

ds = fill(10, length(p0s))
spin(x,args...) = 3-2x

maxiter = 100
tol = 1e-12
maxiter_vumps = 20
tol_vumps = 1e-14

bps = []

function run!(bps)
    # A0 = reshape([0.1 0.1; 0.1 10], 1,1,2,2)
    A0 = [0.2568476712330793 0.3896559989112021 -0.1021093177787983 0.1544583648146971 0.031137654696999893 -0.009249864078955153 0.10416923837439593 0.012367822812528056 0.07680425827216537 -0.10742968425842772; 0.08701386123150273 0.12978417113328133 0.008374970861961185 0.09212619760292318 0.08915923777948949 0.033030854799343805 -0.0043059219832816105 0.03178497853557814 -0.13921047042868046 0.11551286986497389; -0.07658824152902234 -0.15999763912777773 0.014216752203757486 0.030769678132830342 -0.09103565570637963 -0.0934594514839751 0.1818096228669905 -0.05990994721313697 0.20658199854533504 -0.2288757475985779; -0.0009730864635713702 0.010049007670252973 0.04258234235037367 0.03556669065781348 0.06618908438242599 0.028316257568909195 -0.032471644086976205 0.042955215849190743 -0.13784228704535853 0.10402355743203083; -0.03286922550326788 -0.04859090942929271 0.02925397264230264 0.005748344824450929 0.01814274479399834 -0.0038995625232048953 -0.007437906368939332 0.019756616718244895 -0.03972607688927129 0.020572031088586323; -0.02812625474642839 0.004368605149857426 -0.014837921919124603 -0.1332432899818008 0.006080086981824825 0.05752389607278928 -0.1874450858858837 0.017204648894896202 -0.06957714970763178 0.13676433415443245; -0.004301779291393318 -0.031313639385735656 0.023007032394530176 0.0807562593772353 -0.018783147251112034 -0.024371754774247485 0.14673124263261195 -0.03211935643583238 0.03486053110923833 -0.08138526376293603; 0.037814706068219905 0.10959738462119291 -0.07139844335295918 -0.11092681794443097 -0.061554490910411284 0.033163084062393204 -0.09385508992630123 0.003084450509763806 0.07535112678761124 -0.041703726934043374; -0.04880494460876142 -0.14250952985522874 0.10910705794396916 0.1704257026084728 0.08915167759781897 -0.02973573178778644 0.15658276258996914 -0.020336806210276438 -0.13316677228550886 0.08346947787629394; -0.014597547742009052 0.020624005470266063 -0.05112189386654724 -0.11213274429692938 -0.07909836712442377 0.016036386926323486 -0.054458411172469155 -0.020070636056806465 0.08548393730910434 -0.05351263927200832;;; 0.2514082625970353 -0.04989585231827424 0.2658330221896196 0.013240879529186192 -0.1328857755985763 -0.1426847548125696 -0.10866762073174276 -0.08991846463579058 -0.0888865784815526 -0.1104272783571183; -0.04390124616601671 0.0012629822598617254 -0.04020050363700351 0.012056838699041256 0.04258664099052269 0.1327082555801581 0.05844954809219756 -0.008043921348191733 0.03236755600108407 0.03800805089704458; -0.16431677756901383 0.012643068970063261 -0.17014324489186977 0.013557605732323036 0.24735046869270094 0.13839838416804187 0.016248716289685113 0.009714459343050779 0.054814824448029466 -0.12682428084108968; 0.02009338939271126 -0.00045587262438457656 0.030796495413794443 0.0036196884038463446 -0.12286076049537051 0.075973732391309 0.0630704830385335 0.026707967464746428 0.030974804036982738 0.17124112787906398; 0.0478812414909446 -0.030993431865446935 0.060643337486151354 0.027372056148500166 0.07884235379691837 0.08675010226192312 -0.030251976276878655 -0.04165785331408168 0.00960316637568655 -0.11301555751172357; -0.07307632759664426 0.03302810282098169 -0.08809933859278007 -0.029298341510630415 -0.04060626302321545 -0.12869016209770018 -0.001937898452603552 0.06623195546329949 -0.005266071212011698 0.07689147596706639; 0.019455784845669507 -0.001290077175405851 0.01743131253362763 0.003907864946808277 0.03255768599003197 0.002314657849973505 -0.004044825320516262 -0.05324182012386402 -0.026903528038611815 -0.08696155331691954; -0.0826985025947561 0.04323364576271169 -0.10635776796699513 -0.03815328124817916 0.0024342558272452963 -0.26072752982752023 -0.06195077167293238 0.0637753289422828 -0.04091141879884646 -0.05366903251613054; 0.0756110953060282 -0.039594772342025075 0.10103494823708552 0.04810586852251502 0.019479766353279734 0.29902029646610767 0.07801692718541606 -0.10347253325664696 0.030932636825387664 0.020240879595022004; -0.008398309229822236 0.005492443510957024 -0.006462035528369141 0.012992257280767461 0.0034494972457924677 0.04541081311036425 0.04474740098816416 -0.029360455763647708 -0.010242674652183738 0.01185004794071153;;;; 0.2572084127179761 -0.2596624168877829 -0.3278007924027631 0.15295378860793724 0.006785665735331692 -0.05182700967681016 -0.04291950830801091 -0.012066279510964256 0.023909597078301207 0.10522857643359422; 0.05839079939060689 -0.08412064121170977 -0.07294364555007739 0.08499242660778882 -0.013682647410904967 0.014872188730027663 0.027519669555563536 0.17440344261148122 -0.10462919134329678 -0.06712495421901175; -0.0328243520792221 0.07176735094573464 0.08092660246192813 -0.01064779534776996 0.12054174634455057 -0.1318512019958027 -0.022225235358363335 -0.22067373758076272 0.2320470180095054 0.20092712846138952; -0.0268264516888362 0.017395941552318668 0.03767403007398808 0.025830078198058947 -0.013317682809058866 0.02033248114817865 0.029837998882761653 0.1833390459349289 -0.08509695963550297 -0.11821425718820872; -0.03942313449625592 0.03797998478823828 0.05380322914517768 -0.0056272992173094375 0.011463696300263898 -0.010301621746390715 0.003947293976782095 0.0691396983093015 -0.005215133669079881 -0.04592827717402468; -0.0417300135681492 0.04137281332609787 0.018774003227395235 -0.08565682521375768 -0.09421594796909215 0.11684441142504705 -0.010806364858509382 0.030416791111657255 -0.12624784509723072 -0.1106731897451074; 0.006800817301325533 0.01206357290929897 0.025163940137995135 0.05300114001752006 0.05397259438114431 -0.05555242739216997 0.04801597031317574 -0.05453131247006779 0.0692868416032969 0.08018469003979337; 0.04674316599822352 -0.03207238067299153 -0.09513473812848972 -0.05871957809285245 -0.09483096743967785 0.08319339684178903 -0.02045186010145291 -0.10756011044683629 -0.03493574844626809 -0.0309682804248749; -0.06352654239702499 0.057912728902634686 0.1424918219215786 0.09908099657136753 0.12625100510451268 -0.09760688477275621 0.06696953689796076 0.14225138462720002 0.02197813485382049 0.051296449420279666; 0.0024115455285564857 0.01962359520544247 -0.029144626396755306 -0.06858747961996696 -0.07151380388944892 0.06807589277285087 0.0068153153189799065 -0.1573487112351207 -0.011445364507370355 0.004194541107906848;;; 0.2001011495087229 -0.0851655931598738 0.04293733482768504 -0.29517635538289605 0.26090744949126354 -0.03680547703255766 0.09111813510601792 0.06305464961876818 0.008927798503524704 -0.03697601865427755; -0.03944701265307159 0.008986956657556168 0.014444304467062196 0.09884965380599771 -0.07310198903063005 0.042901025558047035 -0.0551092604791615 0.025131468656219104 0.05312767522164745 0.01687403619449845; -0.1156530577038196 0.011574863704239987 0.0029832533363739642 0.2484974459909506 0.023085126524689668 0.00029760903136528575 -0.27722857356434777 -0.11624043084704876 -0.01996366702930328 -0.10558242737933725; -0.005272449768465327 0.01778981463595778 0.008979640542618555 -0.00548503870836217 -0.1800151874248072 0.03222877595316964 0.09571591240899881 0.1596159748698533 0.10876737943989664 0.10497149460282557; 0.038118551031494634 -0.04970207534195822 0.04302365552981576 0.013743133908972537 0.12998487378352586 -0.011454854111979577 -0.16404315651121423 0.054504768195502644 0.07203119122381368 -0.07547319950762271; -0.05496296947142399 0.049342979461977444 -0.052974893463816154 0.003120654605279728 -0.10026586338851179 -0.027048219532323437 0.11216585891252553 -0.06655597976415287 -0.09036261835931159 0.04661388867241744; 0.027567446220113714 -0.011932916259049273 0.012490673652884655 -0.01071194894287379 0.08366173815386628 0.025898900986667566 -0.00861086601611179 -0.10289164529157976 -0.05443681057977396 -0.045780707981007925; -0.04438553939249684 0.04692542754097949 -0.0705896222110148 -0.027641937234708775 0.017892525383363684 -0.06873210478097871 0.10094722482076747 -0.20673190292586374 -0.20873653007015758 -0.03345295853670945; 0.04687007880708832 -0.04545482777209723 0.08806468099240798 0.06657450454436901 -0.01487819041364828 0.09960812391862109 -0.11947752886172859 0.1296746912027117 0.1776213230279002 0.017739507418851864; -0.0037154549001167754 0.008311662857376587 0.010300003671198621 0.03520979201273169 -0.02682124566170057 0.03851034012568295 0.027640394647290466 -0.043594911561317375 -0.016387438326586665 0.013095371414427674]

    for (a, p0) in enumerate(p0s)
        d = ds[a]
        svd_trunc = TruncVUMPS(d)
        bp = mpbp_stationary_infinite_graph(k, [DampedFactor(w, p0)], 2)
        bp.μ[1].tensor = A0
        cb = CB_BPVUMPS(bp; f=spin)
        iter, cb = iterate!(bp; maxiter, svd_trunc, tol, cb)
        A0 = bp.μ[1].tensor
        push!(bps, deepcopy(bp))
        println("Glauber damped - Finished round $a of $(length(p0s)) p0=$(p0)")
    end
end

run!(bps)

r_bp = only.(first.(pair_correlations.(spin, bps)))

jldsave((@__DIR__)*"/../../data/glauber_damped2.jld2"; k, J, h, β, p0s, ds, r_bp, r_ss,
                                                       maxiter, tol, maxiter_vumps, tol_vumps)
